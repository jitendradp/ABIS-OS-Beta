# Prisma data model
This schema is used as the core for the structured data storage on the ABIS platform.  It stores system- as well as user-data and has a few main concepts which will be explained in detail throughout this document. We start by explaining all major entities (types) and then try to put them in perspective by discussing the principles behind this design and its use cases.

## Types
* **User**  
A natural person can sign up an ABIS user. All personal or secret details of the user, like the email address, password hash, phone number, etc.. are stored here. This type must only be used internally. Users interact with other users through their profiles.

* **Session**  
When a user has successfully logged on to ABIS, a session will be created. This type contains the bearer- and csrf-token for that session. These must be used with every api call that requires authentication/authorization. A session is always bound to a profile. When the user switches the profile, a new session must be established.

* **Profile**  
Users can own multiple profiles, at least one. A profile represent a user or bot within a group. A user could own for example a "private" and a "business" profile, both participating in different groups for different purposes and for e.g. notifications. Profiles participate in groups through memberships.

* **Group**  
Groups are the main structural entity in this schema. They contain, entries generated by a user-profile or a system process. Further, all access rights are modelled in terms of groups: _All members of a group can access, all the entries it contains_. Groups can be of type PRIVATE (only the creator is able to view and access it and its contents), ONE_ON_ONE (a group with a immutable membership-list, that only contains two profiles) or ROOM (regular public or private room). A lot of features will utilize hidden system-created or default groups under the hood e.g. contact list etc.

* **Membership**  
A group could have many members, at least always one - the creator and owner of this group. Only a profile can be a member of a group. Memberships can have different states. This ensures a member's approval process. New members could also be limited to only view entries, which have been created after their entry-time of that group. A membership sets all rules in which profiles can interact with resources within a group.

* **Entry**  
Every entry is uniquely identified, has a name and simply stores JSON objects. Every user-interactable object (no matter if message or file) is, at its base, an entry. Entries are broadly categorized as follows:

  * EMPTY: An Entry that has no content (but might have a name and tags).
  * DATA_JSON: Contains an arbitrary json object.
  * DATA_TABLE: Contains metadata about a table (csv, excel, etc.) that is stored somewhere.
  * DATA_DOCUMENT: Contains metadata about an indexable document that is stored somewhere.
  * DATA_PICTURE: Contains metadata about a picture that is stored somewhere.
  * DATA_FILE : Contains metadata about an arbitrary file that is stored somewhere.
  
* **Tag**  
Every object (except: sessions, memberships and tags) can be tagged. A tag consists of a "type" and "value". Each profile, with access to another object, can tag that object exactly once, with any given "type" and "value" combination. Tags, alongside groups, are the second structural entity that can be used to organize information in ABIS. They are used to link different objects together, for example to form a message-thread. _TODO: It might make sense to have "private" Tags. Don't know yet if such properties should be in this model or in a layer above.._TODO: Why only tagged once?_ 

* **Location**  
Stands for a "place on a planet e.g. earth". Can either be an address, geo-position or OSM node. Profiles, groups and entries can have a location attached. Its strictly used on the session for security reasons. This should be used to prevent unwanted logins with fished credentials etc.

## Principles 
### Ownership 
Every object has an "owner" property that links to a profile. By default, the "owner" is equal to the "creator" but an ownership could also be transferred later. The owner is the only one who is allowed to edit or delete the object. However, there could be special cases for entries and groups managed in a membership:

**Group:**
* Members of a group can view entries in it.
* Members of a group can add entries to it.
* Members of a group can only delete their own entries.

**Entry:**  
* Entries can be deleted by the group-owner.
* Deleted entries could always be retrieved by the one who created it.

###  Membership
Groups basically consist of entries and profiles. Access and rights to a group are managed within a membership. Memberships have no owner but creator. The creator of a membership could always cancel it at any time. Memberships can not be transfered.
 
Memberships are formed when a member of a group invites someone to the group. They are then the "creator" of that membership. The first ACTIVE membership in a Group, belongs always to the group-owner.  The membership can be granted conditionally, based on the preferences of the group-owner. The owner can configure the group in a way that puts every new Membership to a PENDING state. Its then up to the group-owner to change that status to ACTIVE.  
  
A special case of Membership is the PUBLIC Membership. It is granted automatically for public Groups. In that case, the Profile that becomes member, is the creator of the Membership (self-invite). 
The only ACTIVE Membership of a public Group ever will be the one of its owner. 

_TODO: What happens if a room is changed from "public" to !"public"?_

### EMPTY-Entries and Link-Tags
A special case of an entry is the EMPTY-Entry. It is used solely as metadata carrier and must not contain any content. The entry's "type"-property must not be changed once the entry was created. The metadata itself is made up from special tags.  
  
This type is used to link other objects together and give them a structure. Examples are: Comments, threads, etc.  

The Tags themselves are not subject of this document. However, there is an essential rule:  
* Link-Tags on EMPTY-Entries are always resolvable by everyone who can see the entry if the link points to another entry of type "DATA_*".
  
## Use cases
### Common user interactions
1) User logs in to ABIS and chooses his profile:  
   * Session with associated profile is created
2) Profile discovers a public group of interest and joins it:  
   * Membership with type PUBLIC is created by the joining profile
3) A profile posts a message to a private group of four members:  
   * A Message-Entry is created by a suitable app and stored to a PRIVATE group.  
   * Then an EMPTY-Entry with a Link-Tag that points to the message is created in the destination group. 
