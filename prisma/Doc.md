# Prisma data model
This schema is used as the core for the structured data storage on the ABIS platform.  It stores system- as well as user-data and has a few main concepts which will be explained in detail throughout this document. We start by explaining all major entities (types) and then try to put them in perspective by discussing the principles behind this design and its use cases.

## Types
* **User**  
A natural person can sign up for an ABIS user. All personal or secret details of the user, like the email address, password hash, phone number, etc.. are stored here. This type must only be used internally. Users interact with other users through their profiles.

* **Session**  
When a user has successfully logged on to ABIS, a session will be created. This type contains the bearer- and csrf-token for that session. These must be used with every API call that requires authentication/authorization. A session is always bound to a profile. When the user switches the profile, a new session must be established.

* **Profile**  
Users can own multiple profiles, at least one. A profile represents a user or bot within a group. A user could own for example a "private" and a "business" profile, both participating in different groups for different purposes and e.g. notifications. Profiles participate in groups through memberships.

* **Group**  
Groups are the main structural entity in this schema. They contain, entries generated by a user-profile or a system process. Further, all access rights are modeled in terms of groups: _All members of a group can access, all the entries it contains_. Groups can be of type PRIVATE (only the creator can view and access it and its contents), ONE_ON_ONE (a group with an immutable membership-list, that only contains two profiles) or ROOM (regular public or private room). A lot of features will utilize hidden system-created or default groups under the hood e.g. contact list etc.

* **Membership**  
A group could have many members, at least always one - the creator and owner of this group. Only a profile can be a member of a group. Memberships can have different states. This ensures a member's approval process. New members could also be limited to only view entries, which have been created after their entry-time of that group. A membership sets all rules in which profiles can interact with resources within a group.

* **Entry**  
Every entry is uniquely identified, has a name and simply stores JSON objects. Every user-interactable object (no matter if message or file) is, at its base, an entry. Entries are broadly categorized as follows:

  * EMPTY: An Entry that has no content (but might have a name and tags).
  * DATA_JSON: Contains an arbitrary JSON object.
  * DATA_TABLE: Contains metadata about a table (CSV, Excel, etc.) that is stored somewhere.
  * DATA_DOCUMENT: Contains metadata about an indexable document that is stored somewhere.
  * DATA_PICTURE: Contains metadata about a picture that is stored somewhere.
  * DATA_FILE: Contains metadata about an arbitrary file that is stored somewhere.
  
* **Tag**  
Every object (except sessions, memberships, and tags) can be tagged. A tag consists of a "type" and "value". Each profile, with access to another object, can tag that object exactly once, with any given "type" and "value" combination. Tags, alongside groups, are the second structural entity that can be used to organize information in ABIS. They are used to link different objects together, for example, to form a message-thread. _TODO: It might make sense to have "private" Tags. Don't know yet if such properties should be in this model or a layer above.._TODO: Why only tagged once?_ 

* **Location**  
Stands for a "place on a planet e.g. earth". It can either be an address, geo-position or OSM node. Profiles, groups, and entries can have a location attached. Its strictly used on the session for security reasons. This should be used to prevent unwanted logins with fished credentials etc.

## Principles 
### Ownership 
Every object has an "owner" property that links to a profile. By default, the "owner" is equal to the "creator" but ownership could also be transferred later. The owner is the only one who is allowed to edit or delete the object. However, there could be special cases for entries and groups managed in a membership:

**Group:**
* Members of a group can view entries in it.
* Members of a group can add entries to it.
* Members of a group can only delete their entries.

**Entry:**  
* Entries can be deleted by the group-owner.
* Deleted entries could always be retrieved by the one who created it.

###  Membership
Groups consist of entries and profiles. Access and rights to a group are managed within a membership. Memberships have no owner but creator. The creator of membership could always cancel it at any time. Memberships can not be transferred.
 
Memberships are formed when a member of a group invites someone to the group. They are then the "creator" of that membership. The first ACTIVE membership in a Group belongs always to the group-owner.  The membership can be granted conditionally, based on the preferences of the group-owner. The owner can configure the group in a way that puts every new Membership to a PENDING state. It's then up to the group-owner to change that status to ACTIVE.  
  
A special case of Membership is the PUBLIC Membership. It is granted automatically for public Groups. In that case, the Profile that becomes a member is the creator of the Membership (self-invited). 
The only ACTIVE Membership of a public Group ever will be one of its owners. 

_TODO: What happens if a room is changed from "public" to!" public"?_

### EMPTY-Entries and Link-Tags
A special case of an entry is the EMPTY-Entry. It is used solely as a metadata carrier and must not contain any content. The entry's "type"-the property must not be changed once the entry was created. The metadata itself is made up of special tags.  
  
This type is used to link other objects together and give them a structure. Examples are Comments, threads, etc.  

The Tags themselves are not subject to this document. However, there is an essential rule:  
* Link-Tags on EMPTY-Entries are always resolvable by everyone who can see the entry if the link points to another entry of type "DATA_*".
  
## Use cases
### Common user interactions
1) An unknown person registers a user account on ABIS and creates his first profile.
2) The person logs in to ABIS and chooses his profile. The last page he visited with this profile is now restored.
3) The user creates a second profile for his working purposes. Different groups, resources, actions, and contacts are listed there.
4) The user joins a public group and posts a comment. Other user profiles within this group, interact with it e.g. starting to like or commenting it.
5) The owner of the group thinks some content that was posted is inappropriate. So he decides to delete some entries posted. But, the one user who posted that inappropriate content reactivates it again. The group owner cancels his membership on that group and locks him out.
6) A user wants to deploy a smart app with his working profile. He browses the cloud store in ABIS and chooses a smart app that contains some market data about the environment and a free flight-calculator for CO2-Footprints. He installs the smart-app within his user-dataspace and starts working with that app. After a while he decides to post some calculations, he had made with this app, to some groups where he is a member. Some groups, where he wants posts stuff from this app in, are in his working and others in his private profile.
7) A user discovers an interesting post in a public group with his private profile and wants to share it within his private working group. He shares the post it on behalf of his working profile to three different private groups where he is a member. Then he also thinks it might be interesting for his family members too. So he decides to post it on behalf of his private profile to several groups too.
8) Some apps are used to create a shared experience and trigger workflows. A workflow from an app was triggered and a user receives a notification within his e.g. working profile. He checks the lastest news and clicks on the notification. He is forwarded to the group channel thread where he was mentioned at. A different user, his boss needs confirmation. He checks it and grants it. The boss is now notified and the dialog changes to status fulfilled.
